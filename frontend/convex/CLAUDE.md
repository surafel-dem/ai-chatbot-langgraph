# CLAUDE.md - Convex Database & Backend Functions Guide

This file provides guidance to Claude Code when working with Convex database and backend functions.

## ğŸ“ Directory Overview

```
convex/
â”œâ”€â”€ CLAUDE.md              # This file
â”œâ”€â”€ README.md              # Basic Convex documentation
â”œâ”€â”€ CONVEX_SETUP.md        # Setup instructions
â”œâ”€â”€ _generated/            # Auto-generated by Convex (DO NOT EDIT)
â”‚   â”œâ”€â”€ api.d.ts          # API type definitions
â”‚   â”œâ”€â”€ dataModel.d.ts    # Data model types
â”‚   â””â”€â”€ server.js         # Server utilities
â”œâ”€â”€ schema.ts             # Database schema definition
â”œâ”€â”€ auth.ts               # Authentication functions
â”œâ”€â”€ auth.config.ts        # Auth configuration
â”œâ”€â”€ agent.ts              # Chat agent functions
â”œâ”€â”€ users.ts              # User management
â”œâ”€â”€ crons.ts              # Scheduled tasks
â”œâ”€â”€ http.ts               # HTTP endpoints
â””â”€â”€ convex_docs/          # Additional documentation
    â”œâ”€â”€ README.md
    â”œâ”€â”€ CONVEX_CLERK_INTEGRATION.md
    â””â”€â”€ convex_with_clerk.md
```

## ğŸ—„ï¸ Database Schema

### Core Tables (from schema.ts)

```typescript
// Users table
users: {
  clerkId: string        // Clerk user ID
  email: string          // User email
  name?: string          // Optional display name
  imageUrl?: string      // Profile image
  createdAt: number      // Timestamp
}

// Chat sessions
chatSessions: {
  userId: string         // User or guest ID
  title: string          // Session title
  lastMessage?: string   // Last message preview
  createdAt: number      // Creation time
  updatedAt: number      // Last update
  isGuest: boolean       // Guest session flag
}

// Messages
messages: {
  sessionId: string      // Chat session ID
  userId: string         // Message author
  role: 'user' | 'bot'   // Message role
  content: string        // Message content
  metadata?: object      // Additional data
  createdAt: number      // Timestamp
}
```

## ğŸ” Authentication Flow

### Guest Users
```typescript
// Automatic guest ID generation
const guestId = `guest_${uuid}`;
// Stored in sessionStorage
// Auto-cleanup after 24 hours via crons.ts
```

### Authenticated Users
```typescript
// Clerk JWT validation
// User creation/retrieval in users.ts
// Full persistence in database
```

## ğŸ“ Key Functions

### agent.ts - Main Chat Functions
```typescript
// Core mutations
createOrGetSession()     // Start new chat session
saveMessage()           // Save chat message
updateSessionTitle()    // Update session title

// Core queries
getUserChatsWithHistory()  // Get user's chat history
getSessionMessages()       // Get messages for session
```

### auth.ts - Authentication
```typescript
// Handles Clerk webhook
// User creation and updates
// Session validation
```

### users.ts - User Management
```typescript
createOrGetUser()       // Create or retrieve user
updateUser()            // Update user profile
getUserByClerkId()      // Find user by Clerk ID
```

### crons.ts - Scheduled Tasks
```typescript
cleanupGuestSessions    // Runs daily at 2 AM
// Deletes guest sessions older than 24 hours
```

## ğŸ› ï¸ Working with Convex

### Development Commands
```bash
# Start Convex dev server
npx convex dev

# Deploy to production
npx convex deploy

# Reset database (CAUTION!)
npx convex dev --reset

# View dashboard
npx convex dashboard
```

### Making Schema Changes

1. **Edit schema.ts**
   ```typescript
   // Add new table or field
   newTable: defineTable({
     field: v.string(),
   }).index("by_field", ["field"])
   ```

2. **Run migrations if needed**
   ```bash
   npx convex dev  # Auto-deploys changes
   ```

3. **Update TypeScript types**
   - Types are auto-generated in `_generated/`

## ğŸ” Common Patterns

### Creating a New Function

```typescript
// In appropriate file (e.g., agent.ts)
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

export const myFunction = mutation({
  args: {
    param: v.string(),
  },
  handler: async (ctx, args) => {
    // Implementation
    return result;
  },
});
```

### Using Functions in Frontend

```typescript
// In React component
import { useMutation, useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";

// Query
const data = useQuery(api.agent.getUserChatsWithHistory);

// Mutation
const saveMessage = useMutation(api.agent.saveMessage);
await saveMessage({ content: "Hello" });
```

## ğŸš¨ Important Considerations

### DO NOT:
- Edit files in `_generated/` folder
- Directly modify database without migrations
- Store sensitive data unencrypted
- Create functions without proper validation

### ALWAYS:
- Use proper TypeScript types
- Validate inputs with Convex validators
- Handle errors appropriately
- Update documentation for new functions
- Test with both guest and authenticated users

## ğŸ”§ Environment Variables

Required in `.env.local`:
```bash
NEXT_PUBLIC_CONVEX_URL=https://[your-project].convex.cloud
CONVEX_DEPLOYMENT=dev:[your-deployment]
```

## ğŸ“Š Database Indexes

Current indexes for performance:
- `users.by_clerk_id` - Fast user lookup
- `chatSessions.by_user_id` - User's sessions
- `messages.by_session_id` - Session messages

## ğŸ› Troubleshooting

### Common Issues

1. **"Convex not connected"**
   - Check `npx convex dev` is running
   - Verify NEXT_PUBLIC_CONVEX_URL

2. **"Unauthorized" errors**
   - Check Clerk configuration
   - Verify JWT settings in auth.config.ts

3. **Missing data**
   - Check if running correct deployment
   - Verify database migrations completed

## ğŸ“š Additional Resources

- Detailed Clerk integration: `./convex_docs/CONVEX_CLERK_INTEGRATION.md`
- Setup guide: `./CONVEX_SETUP.md`
- Convex docs: https://docs.convex.dev

## ğŸ”„ Workflow for Database Changes

1. Check current schema in `schema.ts`
2. Make changes following existing patterns
3. Test with `npx convex dev`
4. Update this documentation if adding new tables/functions
5. Add entry to `../CHANGELOG.md`

---
**Note**: The `_generated` folder is managed by Convex. Never edit these files directly. All changes should be made to the source files which will regenerate the appropriate types and functions.